<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Embedded Search (CSE)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Reuse styles from Option A or keep it minimal */
    body { background: #0f1226; color: #e6e9ff; font-family: system-ui; display: grid; place-items: center; min-height: 100vh; margin: 0; }
    .widget { width: min(760px, 92vw); border: 1px solid #2a315e; border-radius: 16px; overflow: hidden; background: #12142b; }
    .bar { padding: 12px 16px; border-bottom: 1px solid #2a315e; background: #1b1f3b; font-weight: 600; color: #9aa3c7; }
    form { display: grid; grid-template-columns: 1fr auto; gap: 10px; padding: 16px; }
    input[type="search"] { background: #10132a; border: 1px solid #2a315e; color: #e6e9ff; padding: 12px 14px; border-radius: 12px; }
    button { background: #6c8cff; color: white; border: none; padding: 12px 16px; border-radius: 12px; font-weight: 600; cursor: pointer; }
    .results { padding: 8px 16px 16px; }
    .item { padding: 12px; border-bottom: 1px solid #2a315e; }
    .item:last-child { border-bottom: none; }
    .title { font-size: 18px; margin: 0 0 6px; }
    .url { color: #9aa3c7; font-size: 13px; margin-bottom: 6px; }
    .snippet { color: #cfd6ff; }
    .pager { display: flex; gap: 8px; padding: 12px 16px; border-top: 1px solid #2a315e; }
    .pager button { background: #27305f; }
    .error { background: #2a1a1a; border: 1px solid #5a2a2a; color: #ffb4b4; border-radius: 10px; padding: 12px; margin: 10px 16px; }
  </style>
</head>
<body>
  <div class="widget">
    <div class="bar">Embedded Search (CSE)</div>

    <form id="searchForm" autocomplete="off">
      <input id="q" type="search" placeholder="Search the web…" />
      <button type="submit">Search</button>
    </form>

    <div id="status" class="results" hidden>Searching…</div>
    <div id="results" class="results"></div>

    <div id="pager" class="pager" hidden>
      <button id="nextBtn">Next</button>
    </div>
  </div>

  <script>
    const form = document.getElementById("searchForm");
    const input = document.getElementById("q");
    const status = document.getElementById("status");
    const results = document.getElementById("results");
    const pager = document.getElementById("pager");
    const nextBtn = document.getElementById("nextBtn");

    let currentQuery = "";
    let nextStart = null;

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      currentQuery = input.value.trim();
      if (!currentQuery) return;
      await doSearch(currentQuery, 1);
    });

    nextBtn.addEventListener("click", async () => {
      if (nextStart) await doSearch(currentQuery, nextStart);
    });

    async function doSearch(q, start) {
      status.hidden = false;
      status.textContent = "Searching…";
      pager.hidden = true;
      results.innerHTML = "";
      try {
        const r = await fetch(`/search?q=${encodeURIComponent(q)}&start=${start}`);
        const data = await r.json();
        status.hidden = true;
        if (!r.ok) {
          renderError(data.error || "Request failed");
          return;
        }
        renderResults(data.items || []);
        nextStart = data.nextStart || null;
        pager.hidden = !nextStart;
      } catch (err) {
        status.hidden = true;
        renderError("Network error. Please try again.");
      }
    }

    function renderResults(items) {
      results.innerHTML = items.map(it => `
        <div class="item">
          <h3 class="title"><a href="${it.url}" target="_blank" rel="noopener noreferrer">${escapeHtml(it.title)}</a></h3>
          <div class="url">${escapeHtml(it.displayUrl)}</div>
          <div class="snippet">${escapeHtml(it.snippet)}</div>
        </div>
      `).join("");
    }
    function renderError(msg) {
      results.innerHTML = `<div class="error">${msg}</div>`;
    }
    function escapeHtml(s) {
      return s.replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));
    }
  </script>
</body>
</html>
